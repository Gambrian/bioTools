---
title: "SingCellRNASeq"
author: "jmzhang"
date: "2021/7/31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(tidyverse, warn.conflicts = F)
library(RColorBrewer, warn.conflicts = F)
library(Seurat, warn.conflicts = F)
library(patchwork, warn.conflicts = F)
library(ggsci, warn.conflicts = F)
```

## (ä¸€)é¢„å¤‡çŸ¥è¯†ï¼šè¯»å–æ•°æ®åŠæ„å»ºSeuratå¯¹è±¡
- ä»€ä¹ˆæ˜¯Seuratå¯¹è±¡ï¼Ÿå®˜ç½‘çš„è§£é‡Šæ˜¯Seurat Objectæ˜¯ä¸€ä¸ªå®¹å™¨container 
- cellrangeråˆ†æå¾—åˆ°å¸¸è§æ•°æ®ï¼šåç§°éœ€è¦å›ºå®šï¼š
  - barcodes.tsv  åŒºåˆ†ç»†èƒ
  - genes.tsv     åŸºå› ä¿¡æ¯ï¼Œsymbolï¼ŒåŠŸèƒ½ç­‰
  - matrix.mtx    åŸºå› è¡¨è¾¾çŸ©é˜µ
```{r}
single.data <- Read10X('data/GSM3972018/')
CreateSeuratObject(counts = single.data,
                   min.cells = 3, #è¿‡æ»¤åŸºå› 
                   min.features = 200 # è¿‡æ»¤ç»†èƒ
                   ) -> seurat.ob1
#å…¶ä¸­assaysï¼šåˆ†æçš„æ„æ€ï¼Œå­˜æ”¾åŸå§‹çš„countï¼Œ
glimpse(seurat.ob1) 
#assaysæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªRNAå¯¹è±¡ï¼ŒRNAå¯¹è±¡æœ‰8ä¸ªå±æ€§ï¼ŒåŒ…å«åŸå§‹countï¼Œä»¥åŠä¼šå­˜æ”¾æ ‡å‡†åŒ–ä¹‹åçš„dataç­‰ç­‰
#æ—¢ç„¶assayæ”¾äº†RNAéš¾é“ä»¥åä¹Ÿå¯ä»¥æ”¾DNAä¹‹ç±»çš„ä¿¡æ¯ï¼Ÿå‘ç°å…¶å®æ˜¯å¯ä»¥åœ¨assaysä¸­è‡ªå®šä¹‰
glimpse(seurat.ob1@assays) 
#ç»†èƒä¿¡æ¯è¡¨ï¼Œä¹Ÿå°±æ˜¯æ™®é€šè½¬å½•ç»„è¯´çš„ç»†èƒä¿¡æ¯è¡¨
seurat.ob1@meta.data %>% head()
#å¯ä»¥çœ‹åˆ°ç¨€ç–çŸ©é˜µå…¶å®å°†0æ¢æˆäº†.
#head(seob@assays$RNA@counts)
```
- cellrangeråˆ†æå¾—åˆ°çš„h5æ–‡ä»¶ä»¥åŠç›´æ¥ä»è¡¨è¾¾çŸ©é˜µè·å–ï¼š
```{r message=FALSE, warning=FALSE}
# æ„å»ºSeuratå¯¹è±¡å’Œä¸Šé¢æ–¹æ³•ä¸€è‡´
single.data2 <- Read10X_h5('data/GSM3489182/GSM3489182_Donor_01_filtered_gene_bc_matrices_h5.h5')
single.data3 <- read.table('data/GSM2829942/GSM2829942_HE6W_LA.TPM.txt',
                           row.names = 1,
                           header = T)
```

## (äºŒ)åŸºç¡€åˆ†æï¼š
- è¯»å…¥é¡¹ç›®æ•°æ®ï¼Œå¹¶ä¸”åˆä¸ºä¸€ä¸ªSueratå¯¹è±¡
```{r}
sample_name <- basename(list.dirs('data/GSE96583/', recursive = F))
seurat_list <- list()
for(sample in sample_name){
  seurat_data <- Read10X(str_c('data/GSE96583/', sample))
  seurat_ob <- CreateSeuratObject(counts = seurat_data,
                                  min.cell = 3,
                                  min.features = 200)
  seurat_ob@meta.data$sample = sample
  seurat_list[[sample]] = seurat_ob
}

seob <- merge(x = seurat_list[[1]], 
              y = seurat_list[-1],
              #æ·»åŠ ç»†èƒå‰ç¼€ï¼Œé˜²æ­¢åˆå¹¶ä¹‹åå­˜åœ¨ç›¸åŒçš„barcodes
              add.cell.ids = names(seurat_list) 
              )
save(seob, file = 'results/seob_input.RData')
load('results/seob_input.RData')
glimpse(seob)
dim(seob)
```

## (ä¸‰)æ•°æ®è´¨æ§å’Œè¿‡æ»¤ï¼š
- ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸‹å‡ ä¸ªè§’åº¦è¿‡æ»¤ç»†èƒï¼š
  - çº¿ç²’ä½“åŸºå› çš„è½¬å½•æœ¬åœ¨æ¯ä¸ªç»†èƒä¸­æ€»è½¬å½•æœ¬çš„å æ¯”(è¿™é‡Œå…¶å®çœ‹çš„ä¸æ˜¯è½¬å½•æœ¬çš„countè€Œæ˜¯åŸºå› çš„count)
  - ç»†èƒä¸­åŸºå› è¡¨è¾¾çš„ä¸ªæ•°
### çº¿ç²’ä½“å æ¯”ï¼š
#### Seuratæ–¹æ³•ï¼š
```{r}
load('results/seob_input.RData')
#ç¨€ç–çŸ©é˜µçš„è¡Œå’Œåˆ—åï¼Œå­˜åœ¨äº†Dimnamesè¿™ä¸ªåˆ—è¡¨çš„ä¸¤ä¸ªå…ƒç´ ä¸­ï¼Œä½†å…¶å®è¿™ä¸ªcountsä¹Ÿæ˜¯æœ‰çš„
glimpse(seob@assays$RNA@counts@Dimnames);colnames(seob@assays$RNA@counts)[1:5];rownames(seob@assays$RNA@counts)[1:5]
#ï¼Ÿï¼Ÿç­›é€‰åˆ°çº¿ç²’ä½“åŸºå› ï¼Œéœ€è¦å¯¹ç¨€ç–çŸ©é˜µæ“ä½œï¼Œè¿™é‡Œä¸çŸ¥é“æ€ä¹ˆå®ç°
str_subset(seob@assays$RNA@counts@Dimnames[[1]], '^MT-')
#seobè¿™ä¸ªå¯¹è±¡é»˜è®¤è¢«çœ‹åˆ°çš„æ˜¯å…¶å®å°±æ˜¯è¿™ä¸ªmeta.dataï¼Œå¯èƒ½å’Œpythonä¸­çš„__str__æ–¹æ³•ç±»ä¼¼
head(seob@meta.data);head(seob) 

#ps:ä¹‹å‰ä»æ¥æ²¡æœ‰æ³¨æ„çš„ç‚¹ï¼Œdata.frame[]ä¸€å±‚æ‹¬å·å–å‡ºçš„ä»æ˜¯data.frame,[[]]å–å‡ºçš„æ˜¯å‘é‡
#ps:å¯¹data.frame[]èµ‹å€¼ï¼Œéœ€è¦æ¥å—data.frameï¼Œè€Œdata.frame[[]]èµ‹å€¼éœ€è¦æ˜¯å‘é‡ç­‰ä»·äº$
#è¿™é‡Œæ— æ³•ç†è§£ä¸ºä½•éœ€è¦ç”¨åŒå±‚æ‹¬å·è€Œå•å±‚åè€Œä¸è¡Œï¼Œ
#ä½†æ˜¯åŒå±‚åŒæ ·æ”¯æŒæ·»åŠ å‘é‡ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§è‡ªå·±çš„ç†è§£åŠ å…¥çº¿ç²’ä½“ä¿¡æ¯ï¼Œå°±å¾ˆè¿·
#æ€»ä¹‹é€šè¿‡PercentageFeatureSetè¿™ä¸ªå‡½æ•°å¯ä»¥ç®—å‡ºæŸäº›åŸºå› (patternæŒ‡å®šæ¨¡å¼ï¼Œfeaturesç›´æ¥ç»™åŸºå› å‘é‡)åœ¨æ¯ä¸ªç»†èƒä¸­çš„å æ¯”

# seob[['percent.mt']] <- PercentageFeatureSet(seob, pattern = '^MT-') #Seuraté»˜è®¤æ¨èçš„å†™æ³•ï¼Œä½†æ˜¯çœ‹ä¸æ‡‚
# seob@meta.data$my.percent.mt1 <- PercentageFeatureSet(seob, pattern = '^MT-')$nCount_RNA
# seob[['my.percent.mt2']] <- PercentageFeatureSet(seob, pattern = '^MT-')$nCount_RNA

seob[['my.percent.mt']] <- PercentageFeatureSet(seob, pattern = '^MT-')$nCount_RNA;head(seob)
```

#### å¦‚ä½•è‡ªå·±ç®—ï¼Ÿ
```{r}
# è¯•ä¸€è¯•æ±‚çº¿ç²’ä½“çš„ç™¾åˆ†æ¯”ï¼Œæ•°æ®å¤ªå¤§ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ²¡æœ‰æ€è·¯ï¼Œå¯ä»¥åˆ—ä¸€åˆ—çš„æ±‚
dim(seob@assays$RNA@counts)
colnames(seob@assays$RNA@counts)[1:10]

as.data.frame(seob@assays$RNA@counts[,1]) %>% 
  rename(`ctrl_AAACATACAATGCC-1` = colnames(.)[1]) %>%
  rownames_to_column(var = 'gene') -> tmp

#åŸºå› çš„countæ€»æ•°2344
tmp %>% 
  summarise(sum(`ctrl_AAACATACAATGCC-1`)) 

#çº¿ç²’ä½“åŸºå› çš„countæ€»æ•°46  
tmp %>%
  filter(str_detect(gene, '^MT-')) %>%
  summarise(sum(`ctrl_AAACATACAATGCC-1`)) # 46

#å…±æœ‰874ä¸ªåŸºå› å­˜åœ¨count
tmp %>% 
  filter(`ctrl_AAACATACAATGCC-1`>0) %>%
  count()
```

#### å¯é€‰ï¼åŠ å…¥ç»†èƒå‘¨æœŸ
ç›®çš„ï¼šä¸ºäº†é˜²æ­¢ç»†èƒå‘¨æœŸè¿™ä¸ªåå˜é‡å¯¹åç»­åˆ†æé€ æˆçš„å½±å“ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°ä¸åŒç±»å‹æˆ–è€…ä¸åŒå¤„ç†çš„ç»†èƒèšç±»åˆ°ä¸€èµ·ï¼Œä½†å´å‘ç°ç»†èƒæ˜¯æŒ‰ç…§ç»†èƒå‘¨æœŸèšç±»å°±å¾ˆå°´å°¬ï¼Œéœ€è¦å»é™¤ç»†èƒå‘¨æœŸè¿™ä¸ªåå˜é‡ã€‚
æ–¹æ³•ï¼šå¯¹æ¯ä¸ªç»†èƒè¿›è¡Œç»†èƒå‘¨æœŸæ‰“åˆ†ï¼ŒSeuratå†…éƒ¨æœ‰`cc.genes`è¿™ä¸ªæ•°æ®é›†ï¼Œåˆ†åˆ«åŒ…å¥½äº†äººç±»ç»†èƒsæœŸçš„markeråŸºå› ä»¥åŠg2mæœŸçš„markeråŸºå› (æœ‰äº›ç‰©ç§ç»†èƒå‘¨æœŸçš„åŸºå› ç ”ç©¶çš„ç›¸å¯¹æ¯”è¾ƒé€å½»)ï¼Œæ ¹æ®ç»†èƒä¸­è¿™äº›markerçš„è¡¨è¾¾è¡¨è¾¾æƒ…å†µç¡®å®šç»†èƒçš„å‘¨æœŸå¹¶ç»™å‡ºç›¸åº”å¾—åˆ†ã€‚é—®é¢˜æ˜¯ï¼Œå¦‚æœæ˜¯éäººå’Œå°é¼ çš„å¦‚ä½•è®¡ç®—ï¼ŸçŸ¥é“äº†ç»†èƒå‘¨æœŸç›¸å…³çš„markeråŸºå› æœ‰åŠæ³•è®¡ç®—å—ï¼Ÿ
```{r}
#ç¡®è®¤ä¸€ä¸‹è¿™äº›markeråŸºå› æ˜¯å¦åœ¨æˆ‘ä»¬çš„è¡¨è¾¾çŸ©é˜µä¸­ï¼Œå†è¿›è¡Œæ‰“åˆ†ï¼Œé˜²æ­¢åŸºå› å¤§å°å†™é”™è¯¯çš„åŸºå› é›†ç­‰
table(cc.genes$s.genes %in% rownames(seob@assays$RNA@counts))
table(cc.genes$g2m.genes %in% rownames(seob@assays$RNA@counts))

#è¿™ä¸ªå‡½æ•°è¾“å…¥ä¸€ä¸ªseobå¹¶è¿”å›ä¸€ä¸ªå†meta.dataä¸­æ·»åŠ äº†ç»†èƒå‘¨æœŸä¿¡æ¯çš„seob
CellCycleScoring(seob,
                 s.features = cc.genes$s.genes,
                 g2m.features = cc.genes$g2m.genes) -> seob
glimpse(seob)
```

### å¯è§†åŒ–
```{r}
#ä¸€èˆ¬Seuratç”»å›¾ï¼Œä¼šæŒ‰ç…§meta.dataä¸­çš„orig.identåˆ†ç»„ï¼Œå¯åœ¨æ„å»ºSeuratå¯¹è±¡çš„projectå‚æ•°æŒ‡å®š
#æ€è·¯ï¼šä¸€èˆ¬æ¥è®²ï¼ŒåŸºå› çš„æ•°ç›®å’Œè½¬å½•æœ¬çš„æ•°ç›®ç›¸å…³æ€§è¾ƒé«˜ã€‚
#      é‡åˆ°ä¸€äº›å¾ˆç¦»æ•£çš„ç»†èƒï¼Œæœ€ç¨³å¦¥çš„æ˜¯å–å‡ºä»–ä»¬ï¼Œé€šè¿‡markeråŸºå› è¿›è¡Œæ³¨é‡Šï¼Œçœ‹è¿™äº›ç»†èƒ
#      æ˜¯å¦åŒ…å«å¤šä¸ªç»†èƒmarkerï¼Œè¯´æ˜è¿™ä¸ªç£ç åŒ…å«äº†å¤šä¸ªç»†èƒï¼Œå¦‚æœæ˜¯çº¿ç²’ä½“åŸºå› æ¯”ä¾‹è¿‡é«˜å¯è€ƒè™‘æ˜¯ä»€ä¹ˆç»„ç»‡
VlnPlot(seob,
        features = c('nCount_RNA','nFeature_RNA','my.percent.mt'),
        group.by = 'sample')

seob@meta.data %>%
  pivot_longer(cols = c('nCount_RNA','nFeature_RNA','my.percent.mt'),
               names_to = 'class', values_to = 'value') %>% 
  ggplot(aes(x = sample, y = value)) +
    geom_violin(aes(fill = sample)) +
    scale_fill_nejm() +
    geom_point(position = 'jitter', size = .05, alpha = .316) +
    facet_wrap(~class, scales = 'free') +
    labs(y = '', x = '') +
    theme_classic() +
    theme(legend.position = '',
          text = element_text(size = 15, family = 'Times New Roman', face = 'bold'))

RidgePlot(seob, 
          features = c('nCount_RNA','nFeature_RNA','my.percent.mt'),
          group.by = 'sample')

FeatureScatter(seob,
               feature1 = 'nCount_RNA',
               feature2 = 'my.percent.mt',
               group.by = 'sample') -> p1

FeatureScatter(seob,
               feature1 = 'nCount_RNA',
               feature2 = 'nFeature_RNA',
               group.by = 'sample') -> p2
p1 + p2
```

### è¿‡æ»¤ï¼š
```{r}
# è¿™ä¸ªè¿‡æ»¤å…¶å®æ˜¯å¾ˆä¸»è§‚çš„ï¼Œç­›é€‰å¹¶æå–åŸºå› è¡¨è¾¾çš„æ•°ç›®ä¸è¶³200å’Œå°‘äº2500å¹¶ä¸”çº¿ç²’ä½“åŸºå› å«é‡å°äº10%çš„ç»†èƒ
dim(seob)
subset(seob, 
       subset = nFeature_RNA > 200 & 
         nFeature_RNA < 2500 &
         my.percent.mt < 10) -> seob_fltd
dim(seob_fltd) #è¿‡æ»¤äº†å¤§æ¦‚20ä¸ªç»†èƒ
save(seob_fltd, file = 'results/seob_fltd.RData')
```

## (å››)æ•°æ®é¢„å¤„ç†*****ï¼š
æ€è€ƒï¼šæ ‡å‡†åŒ–æ˜¯å•ç‹¬æ ·æœ¬è¿›è¡Œçš„ï¼Œä¾‹å¦‚cmpï¼ŒRPKMéƒ½æ˜¯ä¸€ä¸ªæ ·æœ¬ä¸€ä¸ªæ ·æœ¬å†…è¿›è¡Œçš„ï¼Œç”±äºTPMæ ‡å‡†åŒ–ä¹‹åæ ·æœ¬å’Œä¸º1å› æ­¤æ˜¯å¯ä»¥ç”¨æ¥è¡¡é‡æ ·æœ¬é—´çš„å·®å¼‚ã€‚å› æ­¤ï¼Œéœ€è¦å¯¹åˆå¹¶çš„Seuratå¯¹è±¡è¿›è¡Œæ ·æœ¬æ‹†åˆ†åˆ†åˆ«è¿›è¡Œæ ‡å‡†åŒ–ï¼Ÿä½†æ˜¯æˆ‘è§‰çš„æ˜¯ä¸éœ€è¦æ‹†åˆ†çš„ï¼Œæˆ‘è®¤ä¸ºè¿™é‡Œçš„æ‹†åˆ†åªæ˜¯ä¸ºäº†åé¢çš„å¯¹é½æ•´åˆã€‚äº‰è®®ï¼šæœ‰äº›è§‚ç‚¹è®¤ä¸ºä¸éœ€è¦scaleä¸­å¿ƒåŒ–ï¼Œå› ä¸ºä¼šå¯¼è‡´æ‰€æœ‰çš„åŸºå› å¯¹å·®å¼‚çš„æƒé‡æ˜¯ä¸€è‡´ï¼›æœ‰äº›è§‚ç‚¹è®¤ä¸ºæ ‡å‡†åŒ–åº”è¯¥é‡‡ç”¨TPMæˆ–è€…ä½¿ç”¨scran(éçº¿æ€§)è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä½¿ç”¨scronå¯¹æ ‡å‡†åŒ–è¿›è¡Œè¯„ä¼°ï¼›å¯¹æ˜¯å¦éœ€è¦logçš„äº‰è®®ï¼Œlogå¯ä½¿æ•°æ®è¿‘ä¼¼äºæ­£å¤ªåˆ†å¸ƒæ›´ç¬¦åˆåˆ†æå·¥å…·å¯¹æ•°æ®åˆ†å¸ƒçš„å‡è®¾ï¼Œä½†åŒæ—¶å¯èƒ½ä¼šå¸¦æ¥è™šå‡çš„å·®å¼‚è¡¨è¾¾ã€‚
- **æ ‡å‡†åŒ–ï¼šæµ‹åºæ·±åº¦ä»¥åŠåŸºå› é•¿åº¦å¯¹åŸºå› å®šé‡çš„å½±å“ã€‚è¿™é‡Œç”¨çš„æ˜¯Logå¾ˆå¥‡æ€ª**
- **ç­›é€‰å…³æ³¨åŸºå› ï¼šç­›é€‰å…·æœ‰ä¸€å®šå˜åŒ–çš„åŸºå› ä½œä¸ºåç»­çš„åˆ†æï¼Œä¸€èˆ¬ä¿ç•™1000-5000ä¸ªåŸºå› åˆ†æï¼Œä¸ç„¶è®¡ç®—é‡è¿‡å¤§ï¼Œä¸€èˆ¬åªæœ‰å˜åŒ–çš„åŸºå› æ‰æœ‰å¿…è¦åˆ†æï¼Œå…¶ä»–åŸºå› å¯èƒ½æ˜¯å™ªç‚¹å½±å“è®¡ç®—å‡†ç¡®æ€§å’Œæ•ˆç‡ï¼Œä¸€èˆ¬å°±ä¿ç•™2000ä¸ªã€‚**
- **æ•´åˆæ•°æ®ï¼šè¿™é‡Œéœ€è¦æ•´åˆå’Œå…ˆå‰çš„mergeä¸åŒï¼Œè¿™é‡Œçš„æ•´åˆåŒ…å«ç»„é—´æ ‡å‡†åŒ–çš„æ„Ÿè§‰ï¼Œå› æ­¤éœ€è¦é€‰å®šä¸€äº›å˜åŒ–æ¯”è¾ƒä¿å®ˆçš„åŸºå› ï¼Œå¹¶è®¤ä¸ºè¿™äº›åŸºå› è¡¨è¾¾åœ¨ä¸åŒæ ·æœ¬ä¸­å˜åŒ–ä¸å¤§ï¼Œåˆ©ç”¨å®ƒä»¬è¿›è¡Œä¸åŒæ ·æœ¬æ°´å¹³å¯¹é½ä¹‹åå°†æ•°æ®æ•´åˆï¼Œè®¤ä¸ºè¿™é‡Œæ•´åˆåçš„æ•°æ®å¯ä»¥ç»„é—´æ¯”è¾ƒã€‚è¿™é‡Œæˆ‘è§‰å¾—æœ‰ç‚¹å¥‡æ€ªï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨TPMå¯¹æ¯ä¸ªæ ·æœ¬è¿›è¡Œæ ‡å‡†åŒ–ä¹‹ååˆå¹¶å‘¢(Seuratæ ‡å‡†åŒ–æ–¹æ³•åªæœ‰LogNormalizeå’ŒSCT)ï¼Ÿæ­¤å¤–è¿™ä¸ªå¯»æ‰¾anchorçš„è¿‡ç¨‹æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Œæ˜¯ç›´æ¥ç­›é€‰ä¸åŒæ ·æœ¬ä¹‹é—´å˜åŒ–ä¸å¤§çš„åŸºå› å—ï¼Ÿç„¶åå°†ä»–ä»¬ä½œä¸ºå¯¹é½çš„æ ‡å‡†å—ï¼Ÿ**
- **æ•´åˆåçš„æ•°æ®è¿›è¡Œscaleä¸­å¿ƒåŒ–ï¼šæ‹‰åˆ°-1åˆ°1ï¼Œè¿™ä¸€ä¸ªæ˜¯å¯¹åˆå¹¶çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œæœ‰çš„ä¸æ¨èè¿›è¡Œscaleã€‚**
```{r echo=TRUE}
load('results/seob_fltd.RData')
seob_list <- SplitObject(seob_fltd, split.by = 'sample')
glimpse(seob_list)
for(i in names(seob_list)){
  seob <- seob_list[[i]]
  seob <- NormalizeData(seob, 
                        normalization.method = 'LogNormalize')
  seob <- FindVariableFeatures(seob,
                             selection.method = 'vst',
                             nfeatures = 1000)
  seob_list[[i]] <- seob
  rm(i, seob)
}

#ç»è¿‡NormalizeDataå’ŒFindVariableFeatureså¯ä»¥çœ‹åˆ°
#var.featuresæ˜¯ç­›é€‰çš„1000ä¸ªåŸºå› 
#NormalizeDataçš„ç»“æœå¯èƒ½æ”¾åœ¨äº†dataé‡Œ
glimpse(seob_list$ctrl@assays$RNA) 
seob_fltd@assays$RNA@counts[8:25,1:5]
seob_list$ctrl@assays$RNA@counts[8:25,1:5]
seob_list$ctrl@assays$RNA@data[8:25,1:5]

# è¿”å›ä¸€ä¸ªIntegrationAnchorSetå¯¹è±¡ï¼Œ
# anchors <- FindIntegrationAnchors(object.list = seob_list,
#                                   normalization.method = 'LogNormalize')
# save(anchors, file = 'results/anchors.RData')
load('results/anchors.RData')
glimpse(anchors)

#æ•´åˆåçš„ç»“æœä¼šå­˜åœ¨æ–°çš„assaysçš„dataä¸­ï¼Œé—®é¢˜æ˜¯è¿™ä¸ªå’Œæ•´åˆå‰çš„dataæ²¡æœ‰å˜åŒ–ğŸ¤£
seob_inte <- IntegrateData(anchorset = anchors,
                           new.assay.name = 'IntegrateData')
DefaultAssay(seob_inte) <- 'IntegrateData'
glimpse(seob_inte)
# seob_list$ctrl@assays$RNA@data[8:25,1:5]
# seob_inte@assays$RNA@data[8:25,1:5]
```

```{r}
load('results/seob_fltd.RData')
# SCTrandformæ˜¯æ–°ç‰ˆSeuratæ¨èçš„æ–¹æ³•ï¼Œ
#  å¯ä»¥æ›¿ä»£NormalizeDataï¼ŒFindVarivableFeaturesï¼ŒScaleData
#  variable.features.nä¸€èˆ¬ç”¨3000ä¸ª
seob_list_SCT <- SplitObject(seob_fltd, split.by = 'sample')
rm(seob_fltd)
for(i in names(seob_list_SCT)){
  seob_list_SCT[[i]] <- SCTransform(
    seob_list_SCT[[i]],
    variable.features.n = 3000,
    verbose = FALSE
  )
}
glimpse(seob_list_SCT$ctrl@assays$RNA)
#ç­›é€‰ç”¨äºæ•´åˆçš„åŸºå› 
features_SCT <- SelectIntegrationFeatures(object.list = seob_list_SCT,
                                          nfeatures = 2000)

#å¯ä»¥ç†è§£ä¸ºåœ¨seoblistä¸­æ·»åŠ ç”¨äºæ•´åˆçš„å±æ€§ï¼Œæ„Ÿè§‰è¿™ä¸€æ­¥è¿›è¡Œäº†æ ·æœ¬å†…æ ‡å‡†åŒ–äº†
seob_list_SCT <- PrepSCTIntegration(object.list = seob_list_SCT)
#å¯»æ‰¾anchors,å…¶ä¸­referenceå¯ä»¥è®¾ç½®ç”¨listçš„å“ªä¸€ä¸ªå…ƒç´ ä½œä¸ºåŸºå‡†
anchors_SCT <- FindIntegrationAnchors(object.list = seob_list_SCT,
                                      normalization.method = 'SCT',
                                      anchor.features = features_SCT)
save(seob_list_SCT, anchors_SCT, file = 'results/seob_SCT_Prep.RData')
rm(list = ls())
load('results/seob_SCT_Prep.RData')
glimpse(seob_list_SCT$ctrl@assays)
rm(seob_SCT, seob_list_SCT);gc()
seob_SCT <- IntegrateData(anchors_SCT,
                          normalization.method = 'SCT',
                          new.assay.name = 'integrated_SCT')
DefaultAssay(seob_SCT) <- 'integrated_SCT'
save(seob_SCT, file = 'results/seob_SCT.RData')
rm(list = ls());gc()
load('results/seob_SCT.RData')

#assaysä¸­åŒ…å«äº†RNAï¼ŒSCTï¼Œintegrated_SCT
#å…¶ä¸­RNAï¼ŒSCTåº”è¯¥åªæ˜¯ç²—æš´çš„å°†ä¸åŒæ ·æœ¬æ‹¼åœ¨ä¸€èµ·ï¼Œæ•´åˆæ˜¯å°†ç›¸åŒåŸºå› çš„è¡Œè¿›è¡Œæ•´åˆ
#å¹¶ä¸”è¿›è¡Œå¯¹é½æ¶ˆé™¤æ‰¹æ¬¡æ•ˆåº”
#å…¶ä¸­integrated_SCTå¯ä»¥ç†è§£ä¸ºå»é™¤äº†æ‰¹æ¬¡æ•ˆåº”æ•´åˆçš„æ•°æ®
glimpse(seob_SCT)
dim(seob_SCT@assays$RNA)
dim(seob_SCT@assays$SCT)
dim(seob_SCT@assays$integrated_SCT)
```

## (äº”)é™ç»´åˆ†æ*****ï¼š
- å¯ä»¥æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨åå˜é‡çš„å½±å“ï¼Œæ­¤å¤–è¿™ä¸€æ­¥å¯ä»¥æ”¾åœ¨æœ€å¼€å§‹mergeä¹‹åï¼Œçœ‹ä¸€ä¸‹æ²¡æœ‰è¿›è¡Œæ•´åˆå–å‡ºæ‰¹æ¬¡æ•ˆåº”çš„åŸå§‹æ•°æ®çš„èšç±»æƒ…å†µï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ã€‚æˆ‘ä»¬å¸Œæœ›çš„æ˜¯åŒä¸€ç±»ç»†èƒèšåœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥æ˜¯åŒä¸€å‘¨æœŸæˆ–è€…ç»Ÿä¸€å¤„ç†çš„ç»†èƒèšåœ¨ä¸€èµ·(è¿™ä¸¤è€…åœ¨æœ¬ç ”ç©¶ä¸­å°±æ˜¯åå˜é‡)ã€‚ä½†æ˜¯ï¼Œåƒæ™®é€šè½¬å½•ç»„ï¼Œæˆ‘ä»¬éœ€è¦æ¯”è¾ƒä¸åŒå¤„ç†ï¼Œå› æ­¤æˆ‘ä»¬å¸Œæœ›çš„æ˜¯ä¸åŒçš„å¤„ç†èšåœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆå…¶ä»–çš„å˜é‡ä¾‹å¦‚ï¼šèº«é«˜ï¼Œä½“é‡...å°±ä¸åº”è¯¥èšç±»åˆ°ä¸€èµ·(åœ¨è¿™ç±»ç ”ç©¶ä¸­æ˜¯åå˜é‡)ã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼šæ˜¯å¸Œæœ›æˆ‘ä»¬çš„æ¨æ–­ä¸å—åˆ°å…¶ä»–å˜é‡çš„å¹²æ‰°ã€‚ä»»ä½•å¹²æ‰°é¡¹éƒ½æ˜¯åå˜é‡ï¼Œæ˜¯éœ€è¦å»é™¤çš„ã€‚
- åœ¨å•ç»†èƒåˆ†æä¸­PCAåˆ†ææ˜¯åŸºäºHVGï¼Œé¦–å…ˆéœ€è¦æ˜ç¡®éœ€è¦ä¿ç•™å¤šä¸ªPCåšåç»­åˆ†æï¼Œä¸€èˆ¬æ ‡å‡†åŒ–å‰20ä¸ªå°±okï¼Œä½†æ˜¯SCTæ ‡å‡†åŒ–æ¯”è¾ƒæ•æ„Ÿéœ€è¦ä¿ç•™30ä¸ªä»¥ä¸Šã€‚PCAåˆ†æä¹‹å‰æ¯ä¸€ä¸ªåŸºå› åˆ†åˆ«æè¿°äº†ç»†èƒä¹‹å‰çš„å·®å¼‚ï¼ŒPCAä¹‹åå°±è½¬å˜ä¸ºPCæè¿°ç»†èƒçš„å·®å¼‚ï¼Œè€Œæ¯ä¸ªPCæ˜¯ä¸€ä¸ªç‰¹å¾å‘é‡åŒ…å«ä¸€éƒ¨åˆ†åŸºå› ï¼Œè¿™éƒ¨åˆ†åŸºå› ä¼šå¯¹PCåˆ†åˆ«æœ‰è´¡çŒ®åº¦ã€‚æœ€ç»ˆå°†æ¯ä¸ªåŸºå› å¯¹ç»†èƒå·®å¼‚çš„æè¿°è½¬å˜ä¸ºå‡ ä¸ªPCå¯¹ç»†èƒå·®å¼‚çš„æè¿°ï¼Œè€ŒTSNEå’ŒUMAPéƒ½æ˜¯åŸºäºPCAåˆ†æã€‚ä¸‹é¢p1-p4PCAçš„ç»“æœåˆ†åˆ«å±•ç¤ºè¿›è¡Œäº†æ•°æ®çŸ«æ­£(å¤„ç†æ‰¹æ¬¡)å’Œæ²¡æœ‰è¿›è¡Œæ•°æ®çŸ«æ­£çš„é™ç»´åˆ†æç»“æœï¼Œå› æ­¤ï¼Œæ‹¿åˆ°æ•°æ®å¯ä»¥é¦–å…ˆè¿›è¡Œä¸€ä¸ªPCAåˆ†æçœ‹çœ‹æ²¡æœ‰è¿›è¡ŒçŸ«æ­£çš„æ•°æ®æ˜¯å¦å­˜åœ¨æ‰¹æ¬¡ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥è€ƒè™‘è·³è¿‡æ•°æ®çŸ«æ­£ï¼Œå› ä¸ºæ•°æ®çŸ«æ­£çš„è¿‡ç¨‹ä¸­ä¼šæŠ¹å¹³ç»†èƒä¹‹é—´çš„å·®å¼‚ã€‚è¿™é‡Œä¸å±•ç¤ºå…¶ä»–é™ç»´åˆ†æçš„ç»“æœçš„æ‰¹æ¬¡ï¼Œâ—â—â—**æ€»ä¹‹æ³¨æ„ï¼šé™ç»´åˆ†æç»†èƒä¹‹é—´è¢«åˆ†å¼€ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¿™ç§åˆ†å¼€æ˜¯ç»†èƒç±»å‹çš„å·®å¼‚è¿˜æ˜¯ç”±äºå‘¨æœŸï¼Œæ‰¹æ¬¡ç­‰å…¶ä»–åå˜é‡å¯¼è‡´çš„**
```{r}
load('results/seob_SCT.RData')
glimpse(seob_SCT@reductions)

#å¯¹assays@RNAè¿›è¡ŒPCAéœ€è¦å¯»æ‰¾RNAä¸­çš„ç‰¹å¾åŸºå› å¹¶ä¸”è¿›è¡Œscale
seob_SCT <- FindVariableFeatures(seob_SCT, 
                                 selection.method = 'vst',
                                 nfeatures = 2000, assay = 'RNA')
seob_SCT <- ScaleData(object = seob_SCT, assay = 'RNA')

#è¿›è¡Œåˆ†æçš„æ—¶å€™ï¼Œé€šè¿‡assayæŒ‡å®šè¾“å…¥ï¼Œé€šè¿‡reduction.nameæŒ‡å®šè¾“å‡ºï¼Œé€šè¿‡keyç»™ä¸ªå‰ç¼€æ–¹ä¾¿ç”»å›¾
seob_SCT <- RunPCA(seob_SCT, assay = 'integrated_SCT',  reduction.name = 'PCA_SCT', reduction.key = 'SCT_PC')
seob_SCT <- RunPCA(seob_SCT, assay = 'RNA', reduction.name = 'PCA_RNA', reduction.key = 'RNA_PC')

DimPlot(seob_SCT, reduction = 'PCA_SCT', group.by = 'sample') -> p1
DimPlot(seob_SCT, reduction = 'PCA_RNA', group.by = 'sample') -> p2

p1 + p2 + plot_layout(guides = 'collect')
```

```{r}
#PCAï¼Œt-SNEï¼Œu-MAPç­‰ä¸€ç³»åˆ—é™ç»´åˆ†æç»“æœ
ElbowPlot(seob_SCT, ndims = 50, reduction = 'PCA_SCT')

seob_SCT <- RunTSNE(seob_SCT, reduction = 'PCA_SCT', reduction.name = 'tsne_SCT', dims = 1:30)
seob_SCT <- RunUMAP(seob_SCT, reduction = 'PCA_SCT', reduction.name = 'umap_SCT', dims = 1:30)


DimPlot(seob_SCT, reduction = 'tsne_SCT', group.by = 'sample') -> p3
DimPlot(seob_SCT, reduction = 'umap_SCT', group.by = 'sample') -> p4

p1 + p3 + p4 + plot_layout(guides = 'collect')
save(seob_SCT, file = 'results/seob_SCT_reducted.RData')
```


## (å…­)èšç±»åˆ†æåŠç»†èƒæ³¨é‡Š*****ï¼š
- èšç±»æ–¹æ³•é‡‡ç”¨çš„æ˜¯K-NNèšç±»ï¼Œéœ€åŸºäºPCAçš„ç»“æœï¼Œä¸ºä½•èšç±»ï¼Ÿé€šè¿‡è®¡ç®—å°†è·ç¦»è¾ƒè¿‘çš„ç»†èƒå½’ä¸ºä¸€ä¸ªclusterã€‚åˆ†ä¸ºä¸¤æ­¥é¦–å…ˆæ˜¯`FindNeighbors`ç„¶åæ˜¯`FindClusters`ï¼ŒFindNeighborsçš„ç»“æœå­˜æ”¾åœ¨graphä¸­éœ€è¦æŒ‡å®šå¯¹å“ªä¸ªreductionè¿›è¡Œï¼Œé€šè¿‡graph.nameç»™æ¯ä¸ªç»“æœå‘½åï¼Œå› æ­¤FindClusterséœ€è¦æŒ‡å®šå¯¹å“ªä¸ªgraphè¿›è¡Œèšç±»ï¼Œå…¶ç»“æœå­˜æ”¾åœ¨metadataä¸­ã€‚â—â—â—**æ³¨æ„ï¼šç»è¿‡FindClustersä¹‹åmetadataä¸­ä¼šæ–°å¢ä¸¤åˆ—ï¼Œä¸€åˆ—ä¸ºå¯¹åº”çš„`graph.name_åˆ†è¾¨ç‡`ï¼Œå¦ä¸€åˆ—ä¸ºseurat_clustersï¼Œå› æ­¤seurat_clustersä¼šè¢«è¦†ç›–ã€‚**
```{r}
rm(list=ls());gc()
load('results/seob_SCT_reducted.RData')
seob_SCT <- FindNeighbors(seob_SCT, reduction = 'PCA_SCT',graph.name = 'graph_SCT',
                          #k.param = 20, #æœ€è¿‘çš„20ä¸ªç»†èƒæ€§èƒ½ä¸è¶³çš„æ—¶å€™å¯ä»¥è€ƒè™‘
                          dims = 1:30)
seob_SCT <- FindNeighbors(seob_SCT, reduction = 'PCA_RNA',graph.name = 'graph_RNA',
                          #k.param = 20, #æœ€è¿‘çš„20ä¸ªç»†èƒæ€§èƒ½ä¸è¶³çš„æ—¶å€™å¯ä»¥è€ƒè™‘
                          dims = 1:30)

#å¯èƒ½ä¼šé‡åˆ°çš„æƒ…å†µï¼šä¸çŸ¥é“ä½¿ç”¨å¤šå°‘åˆ†è¾¨ç‡è¿™ä¸ªæ—¶å€™å¯ä»¥å¤šæ¬¡FindClusterèšç±»ç„¶åæ ¹æ®åç»­çš„markeræ¥ç¡®å®šåˆ†æˆå¤šå°‘æœ€åˆç†ï¼Ÿ
seob_SCT <- FindClusters(seob_SCT, graph.name = 'graph_RNA',
                         resolution = 0.3, #åˆ†è¾¨ç‡å€¼è¶Šå¤§ï¼Œclusterè¶Šå¤š
                         random.seed = 1)
seob_SCT <- FindClusters(seob_SCT, graph.name = 'graph_SCT',
                         resolution = 0.3, #åˆ†è¾¨ç‡å€¼è¶Šå¤§ï¼Œclusterè¶Šå¤š
                         summarise)
seob_SCT <- FindClusters(seob_SCT, graph.name = 'graph_SCT',
                         resolution = 0.1, #åˆ†è¾¨ç‡å€¼è¶Šå¤§ï¼Œclusterè¶Šå¤š
                         random.seed = 1)
table(seob_SCT@meta.data$graph_SCT_res.0.3)
glimpse(seob_SCT)
head(seob_SCT@meta.data)

p1 <- DimPlot(seob_SCT,
              reduction = 'PCA_RNA',
              group.by = 'graph_RNA_res.0.3',
              label = T)
p2 <- DimPlot(seob_SCT,
              reduction = 'PCA_SCT',
              group.by = 'graph_SCT_res.0.3',
              label = T)
p3 <- DimPlot(seob_SCT,
              reduction = 'tsne_SCT',
              group.by = 'graph_SCT_res.0.3',
              label = T)
p4 <- DimPlot(seob_SCT,
              reduction = 'umap_SCT',
              group.by = 'graph_SCT_res.0.3',
              label = T)

(p1 + p2 )/(p3 + p4) + plot_layout(guides = 'collect')
```
- ç»†èƒæ³¨é‡Šï¼šé€šè¿‡umapä»¥åŠç‚¹å›¾(markeråŸºå› åœ¨å„clusterä¸­çš„è¡¨è¾¾æ°´å¹³ä»¥åŠç™¾åˆ†æ¯”)ç¡®å®šclusterçš„ç»†èƒç±»å‹
```{r}
CellMarker_df <- read_csv("data/CellMarker.csv", col_types = cols(X3 = col_skip())) %>%
  separate_rows(Cell_Marker, sep = ',') %>%
  mutate(Cell_Type = str_remove_all(Cell_Type, ' ')) %>% distinct()

p1 <- DimPlot(seob_SCT,
              reduction = 'umap_SCT',
              group.by = 'graph_SCT_res.0.3',
              label = T)

#è®¾è®¡åˆ°åŸºå› è¡¨è¾¾éƒ½ç”¨RNAä¸­çš„æ•°æ®ï¼Œæ¶‰åŠåˆ°ç»†èƒçš„é™ç»´å’Œèšç±»éœ€è¦ç”¨Inte_SCT
p2 <- DotPlot(seob_SCT,
        features = unique(CellMarker_df$Cell_Marker)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8))
p1 + p2 


FeaturePlot(seob_SCT,
            reduction = 'umap_SCT', #æ³¨æ„ç”¨çš„æ˜¯å“ªä¸€ä¸ªé™ç»´çš„æ•°æ®
            features = c('GNLY','NKG7','CD3D','CD8A'),
            #split.by = 'sample',
            label = T)
VlnPlot(object = seob_SCT,
        features = c('GNLY','NKG7'),group.by ='graph_SCT_res.0.3' , #æ³¨æ„ç”¨çš„æ˜¯ä¸ªä¸€ä¸ªèšç±»
        pt.size = .1,
        assay = 'integrated_SCT'
        #split.by = 'sample'
        )
glimpse(seob_SCT@assays$integrated_SCT)
```

```{r}
#ç»†èƒæ³¨é‡Šï¼š
# è¿™é‡Œæ²¡æœ‰ä»”ç»†åˆ’åˆ†ç›´æ¥å°±ç”¨çš„å¼ è€å¸ˆçš„ï¼Œå¯ä»¥æŒ‰ç…§è¿™ä¸ªä¸€ä¸ªä¸ªæ‰¾å¦‚æœä¸€èµ·çœ‹ä¸å¤ªå¥½çœ‹çš„è¯
# éœ€è¦è®¾ç½®ä¸€ä¸ªclusterå¯¹åº”çš„ç»†èƒç±»å‹ï¼Œç›®çš„æ˜¯å†meta.dataä¸­æ–°å¢ä¸€åˆ—ç»†èƒç±»å‹
DotPlot(seob_SCT,
        features = c('LYZ','CD14')) +
  scale_color_gradient(low = 'grey', high = '#B22222') +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   size = 8))
#ç¬¬ä¸€ç§æ–¹æ³•ï¼š
cluster2type <- c(
  "0"="CD14+ monocytes",
  "1"="CD8+ T cells",
  "2"="CD8+ T cells",
  "3"="CD8+ T / NK cells",
  "4"="NK cells",
  "5"="CD8+ T cells",
  "6"="B cells",
  "7"="FCGR3A+ monocytes",
  "8"="B cells",
  "9"="Conventional dendritic cells",
  "10"="Megakaryocytes", 
  "11"="CD8+ T cells",
  "12"="Plasmacytoid dendritic cells",
  "13"="Erythrocytes"
)
#å¸¦åå­—çš„å‘é‡é€šè¿‡ä¸€å±‚[]è¿”å›ç›¸åº”çš„å¸¦åå­—çš„å…ƒç´ ï¼ŒåŒå±‚[[]]ä¸å¸¦åç§°ï¼Œä½†æ˜¯åŒå±‚åªèƒ½å–å•ä¸ª
#å¤šä¸ªå¯ä»¥é€šè¿‡unnameå¾—åˆ°ä¸å¸¦åç§°çš„
unname(cluster2type[seob_SCT@meta.data$graph_SCT_res.0.3]) %>% head() #èµ‹å€¼ç»™æ–°çš„ä¸€åˆ—å°±å¯ä»¥äº†

#ç¬¬äºŒç§æ–¹æ³•ï¼šä½¿ç”¨left_join
cluster2type <- tibble::tribble(
  ~cluster, ~cell_type,
  "0", "CD14+ monocytes",
  "1", "CD8+ T cells",
  "2", "CD8+ T cells",
  "3", "CD8+ T / NK cells",
  "4", "NK cells",
  "5", "CD8+ T cells",
  "6", "B cells",
  "7", "FCGR3A+ monocytes",
  "8", "B cells",
  "9", "Conventional dendritic cells",
  "10", "Megakaryocytes", 
  "11", "CD8+ T cells",
  "12", "Plasmacytoid dendritic cells",
  "13", "Erythrocytes"
)
unique(cluster2type$cell_type)
#æ³¨æ„ï¼Œleft_joinä¹‹åæ˜¯æ²¡æœ‰è¡Œåçš„ğŸ¤£
seob_SCT@meta.data <- seob_SCT@meta.data %>%
  rownames_to_column(var = 'barcodes') %>%
  left_join(cluster2type, by = c('graph_SCT_res.0.3'='cluster')) %>%
  column_to_rownames(var = 'barcodes')

head(seob_SCT@meta.data)
save(seob_SCT, file = 'results/seob_SCT_cluster_annoed.RData')
```

```{r}
rm(list=ls());gc()
load('results/seob_SCT_reducted.RData')
#å¦‚ä½•è‡ªå·±ç”»umapä»¥åŠå°æç´å›¾ä»¥åŠåŸºå› è¡¨è¾¾çš„umapå›¾
#æ„Ÿè§‰seuratè‡ªå¸¦çš„ç”»å›¾barcodesçš„è¡¨è¾¾çŸ©é˜µä½¿ç”¨çš„æ˜¯SCTä¸­scale.dataï¼Œä½†æ˜¯åˆå’Œè‡ªå¸¦çš„å›¾æœ‰å·®å¼‚ã€‚
#â—â—â—ç›®å‰çš„é—®é¢˜ï¼šä¸€ä¸ªæ˜¯ä¸ç¡®å®šè‡ªå¸¦çš„VlnPlotä½¿ç”¨çš„æ˜¯ä»€ä¹ˆæ•°æ®ï¼Ÿ
#å‡½æ•°è¯´å…¶ä½¿ç”¨çš„æ˜¯active.assayä¸­çš„æ•°æ®ï¼Œç„¶åæˆ‘åˆ†åˆ«ä½¿ç”¨äº†integrated_SCTå…¶ä¸­çš„dataï¼Œscale.dataå‡ä¸è‡ªå¸¦å›¾ä¸ä¸€è‡´
#ä½†æ˜¯å½“æˆ‘ä½¿ç”¨SCTçš„æ•°æ®çš„æ—¶å€™æ—¶å‘ç°ï¼šä¸Seuratè‡ªå¸¦å‡½æ•°ä½¿ç”¨integrated_SCTæ¯”è¾ƒä¸€è‡´ï¼Œä¸Seuratè‡ªå¸¦å‡½æ•°ä½¿ç”¨SCTå®Œå…¨ä¸ä¸€è‡´
#=====> æˆ‘çš„ç›®çš„æ—¶æ˜ç¡®ï¼ŒSeuratä¸­çš„assayåˆ†åˆ«çš„ä½œç”¨ï¼Œä»¥åŠä½œè€…è‡ªå¸¦ç”»å›¾å‡½æ•°æ‰€ä½¿ç”¨çš„æ•°æ®


#æå–integrated_SCT@dataä¸­çš„æ•°æ®
glimpse(unclass(seob_SCT@assays$integrated_SCT@data@x) %>% as.matrix()) %>% head()
matrix(seob_SCT@assays$integrated_SCT@data@x, ncol = 2000) -> exper_
colnames(exper_) <- seob_SCT@assays$integrated_SCT@data@Dimnames[[1]]
rownames(exper_) <- seob_SCT@assays$integrated_SCT@data@Dimnames[[2]]
exper_ %>% as.data.frame() %>% head()

windowsFonts(TNM = windowsFont('Times New Roman'))
getPalette = colorRampPalette(brewer.pal(9, "Set1"))

metadata__ <- seob_SCT@meta.data %>% rownames_to_column(var = 'barcodes') %>%
  select(barcodes, sample, graph_SCT_res.0.3) 

as.data.frame(unclass(seob_SCT@reductions$umap_SCT@cell.embeddings)) %>% rownames_to_column(var = 'barcodes') %>%
  left_join(metadata__, by = 'barcodes') -> plot_data
  
ggplot(plot_data, aes(x = UMAP_1, y = UMAP_2)) +
  geom_point(aes(color = graph_SCT_res.0.3), size = .01) +
  guides(colour = guide_legend(override.aes = list(size = 5), title = 'cluster')) +
  scale_color_manual(values = getPalette(12)) +
  theme_classic() +
  theme(text = element_text(size = 13, family = 'TNM', face = 'bold'))


unclass(unclass(seob_SCT@assays$SCT)@scale.data) %>%
#exper_ %>% as.data.frame() %>%
  t() %>% as.data.frame() %>%
  rownames_to_column(var = 'barcodes') %>% 
  pivot_longer(cols = -1, names_to = 'symbols', values_to = 'value') %>% 
  dplyr::filter(symbols %in% c('GNLY','NKG7')) -> barcodes_expr

plot_data %>% left_join(barcodes_expr, by = 'barcodes') %>%
  ggplot(aes(x = graph_SCT_res.0.3, y = value, fill = graph_SCT_res.0.3)) + 
    geom_violin(trim = TRUE, scale = 'width', adjust = 1) +
    geom_jitter(height = 0, size = .01, show.legend = FALSE, alpha = .2) +
    scale_fill_manual(values = getPalette(10)) +
    facet_wrap(~symbols, scales = 'free')

plot_data %>% left_join(barcodes_expr, by = 'barcodes') %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
    geom_point(aes(color = value)) +
    scale_color_gradient(low = "grey", high = "#B22222") +
    facet_wrap(~symbols, scales = 'free')
```

```{r}
#===> ç›®çš„ï¼šæ¢ç´¢ä¸€ä¸‹Seuratå¯¹è±¡ä¸­assaysä¸­çš„æ•°æ®
TransSeuratData2DataFrame <- function(ob){
  # Seurat@assays$XXX@data => data.frame
  # return -> data.frame
  #   - colnames:gene symbol
  #   - rownames:barcodes
  tmp_matrix <- matrix(ob@data@i, ncol = ob@data@Dim[1])
  rownames(tmp_matrix) <- ob@data@Dimnames[[2]]
  colnames(tmp_matrix) <- ob@data@Dimnames[[1]]
  return(as.data.frame(tmp_matrix))
}
  
TransSeuratData2DataFrame(seob_SCT@assays$RNA)[80:84,100:104]
TransSeuratData2DataFrame(seob_SCT@assays$SCT)[80:84,100:104]
TransSeuratData2DataFrame(seob_SCT@assays$integrated_SCT)[80:84,100:104]

glimpse(seob_SCT@assays)
glimpse(seob_SCT@assays$RNA@data)
glimpse(seob_SCT@assays$SCT@data)
glimpse(seob_SCT@assays$integrated_SCT@data)
14842*30581
glimpse(seob_SCT@assays$integrated_SCT@data)
(seob_SCT@assays$integrated_SCT@data)
(seob_SCT@assays$integrated_SCT@scale.data)


names(table(seob_SCT@assays$SCT@data@x))
seob_SCT@assays$SCT@data@x[1:1000]
glimpse(seob_SCT@assays$SCT@data)
glimpse(seob_SCT@assays$SCT@scale.data)

# assays:
#   RNA:=>å·®å¼‚è¡¨è¾¾åˆ†æï¼ŒåŸºå› è¡¨è¾¾ç›¸å…³çš„å›¾
#     countsï¼šraw counts
#       dim:16135 30581
#     dataï¼šNormalized
#     (å»é™¤æµ‹åºæ·±åº¦å’ŒåŸºå› é•¿åº¦çš„å½±å“) and log transform -> ç»†èƒä¹‹é—´å¯æ¯”
#       dim:16135 30581
#     scale.data:scaled(åšä¸åšå­˜åœ¨äº‰è®®)
#     (å°†åŸºå› çš„æ³¢åŠ¨ç¼©å°åˆ°åŒä¸€ä¸ªèŒƒå›´å†…z-score) and centered(å¤„ç†æ•°æ®ä¸­ä½æ•°ï¼Œå±…ä¸­å¯¹é½)
#       dim:2000 30581
#
#   SCT:å›å½’äº†åå˜é‡(ä¸å…³å¿ƒçš„ç»†èƒå‘¨æœŸï¼Œçº¿ç²’ä½“æ¯”ä¾‹...)
#     counts: 
#       dim:14842 30581
#     data:
#       dim:14842 30581
#     scale.data:
#       dim:2000 30581
#
#   integrated_SCT:å¤šæ ·æœ¬æ•´åˆå»é™¤äº†æ‰¹æ¬¡æ•ˆåº”=>ä¸ç»†èƒç›¸å…³çš„åˆ†æï¼Œé™ç»´èšç±»åˆ†æç­‰ç†è§£ç»†èƒå…³ç³»è·ç¦»ç­‰
#     counts:
#       dim:0 0
#     data:
#       dim:2000 30581
#     scale.data:
#       dim:2000 30581
```

## (ä¸ƒ)å·®å¼‚è¡¨è¾¾åˆ†æ*****ï¼š
- åŒç§æ¡ä»¶(å¤„ç†)ä¸‹ï¼š
  - ä¸¤ç§ä¸åŒç»†èƒç±»å‹ä¹‹é—´å­˜åœ¨é‚£äº›å·®å¼‚è¡¨è¾¾çš„åŸºå› ->å¯ä»¥æ¥è§£é‡Šè§£é‡Šç»†èƒçš„åŠŸèƒ½ï¼Ÿ
  - ä¸€ç§ç»†èƒç±»å‹ä¸å…¶ä»–æ‰€æœ‰ç»†èƒç±»å‹ä¹‹é—´å·®å¼‚è¡¨è¾¾çš„åŸºå› 
- ä¸åŒæ¡ä»¶ä¸‹(å¤„ç†)ï¼š
  - åŒä¸€ç§ç»†èƒåœ¨ä¸åŒå¤„ç†ä¸‹å·®å¼‚è¡¨è¾¾çš„åŸºå› 
```{r}
load('results/seob_SCT_cluster_annoed.RData')

glimpse(seob_SCT)
DimPlot(seob_SCT, 
        group.by = 'cell_type',
        label = T, 
        reduction = 'umap_SCT')

ctrl_seob <- subset(seob_SCT,
                    subset = sample == 'ctrl')
stim_seob <- subset(seob_SCT,
                    subset = sample == 'stim')
dim(ctrl_seob)
dim(stim_seob)

clu1_vs_clu2_ctrl <- FindMarkers(ctrl_seob, ident.1 = 1, ident.2 = 2)
clu1_vs_clu2_stim <- FindMarkers(stim_seob, ident.1 = 1, ident.2 = 2)

#æ¢ç©¶åªåœ¨cluster1ä¸­å·®å¼‚è¡¨è¾¾çš„åŸºå› ï¼Œå¯ä»¥ç†è§£ä¸ºæŸä¸€ä¸ªç±»ç»†èƒç‰¹æ„å·®å¼‚è¡¨è¾¾ï¼Ÿ
`%!in%` = Negate(`%in%`)
clu1_seob <- subset(seob_SCT, subset = graph_SCT_res.0.3 == 1)
Idents(clu1_seob) <- clu1_seob@meta.data$sample;glimpse(clu1_seob)
stim_vs_ctrl_clu1 <- FindMarkers(clu1_seob, ident.1 = 'stim',  ident.2 = 'ctrl')
Idents(seob_SCT) <- seob_SCT@meta.data$sample
stim_vs_ctrl_all <- FindMarkers(seob_SCT, ident.1 = 'stim',  ident.2 = 'ctrl')

stim_vs_ctrl_clu1 %>% 
  rownames_to_column(var = 'gene_symbol') %>%
  filter(gene_symbol %!in% rownames(stim_vs_ctrl_all),
         gene_symbol %in% rownames(de_seob$ctrl),
         gene_symbol %in% rownames(de_seob$stim)) %>%
  arrange(desc(pct.1), pct.2)

Idents(seob_SCT) <- seob_SCT@meta.data$graph_SCT_res.0.3
FeaturePlot(seob_SCT, split.by = 'sample', 
        features = 'RPS18', reduction = 'umap_SCT',
        label = T)


de_seob <- SplitObject(seob_SCT, split.by = 'sample')
for(i in names(de_seob)){
  de_seob[[i]] = FindMarkers(de_seob[[i]], ident.1 = 1)
}


glimpse(de_seob$ctrl@meta.data)


clu1_vs_clu2_all <- FindMarkers(seob_SCT,
                            ident.1 = 1)
clu1_vs_clu2_all %>% arrange(desc(pct.1))
clu1_vs_clu2 %>% arrange(desc(pct.1), pct.2)
FeaturePlot(seob_SCT, split.by = 'sample', 
        features = c('SELL', 'RPL13'), reduction = 'umap_SCT',
        label = T)
ls()
rm(tmp_res)
gc()
Idents(ctrl_seob)
```

```{r}
nk_cell_seob <- subset(seob_SCT,
                       subset = cell_type == 'NK cells')
Idents(nk_cell_seob) <- nk_cell_seob@meta.data$sample
nk_cells_stim_vs_ctrl_markers <- FindMarkers(nk_cell_seob,
            ident.1 = 'stim',
            ident.2 = 'ctrl') # å¤„ç†è¿™ä¸ªconditionä¸‹nkç»†èƒå·®å¼‚è¡¨è¾¾çš„åŸºå› 

Idents(seob_SCT) <- seob_SCT@meta.data$cell_type
nk_vs_all <- FindMarkers(
  seob_SCT,
  ident.1 = 'NK cells')

`%!in%` = Negate(`%in%`)
rownames(nk_cells_stim_vs_ctrl_markers)[rownames(nk_cells_stim_vs_ctrl_markers) 
                                        %!in% rownames(nk_vs_all)]

FeaturePlot(seob_SCT,
            split.by = 'sample',
            features = 'CD1D', label = T)
rm(ctrl_seob, clu1_vs_clu2_all, clu1_vs_clu2)
```

## (å…«)æ‹Ÿæ—¶åºåˆ†æï¼š
- Monocle3å¯ä»¥åšæ ‡å‡†åŒ–ï¼Œå»æ‰¹æ¬¡ï¼Œé™ç»´ï¼Œèšç±»ï¼Œclusteræ¯”è¾ƒï¼Œè½¨è¿¹åˆ†æã€‚æœ‰äº›æ–‡ç« ä¸€æ•´å¥—å‡åˆ†æéƒ½åŸºäºMonocle3ï¼Œæ­¤å¼€å‘å›¢é˜Ÿå¼€å‘çš„Garnettå¯ä»¥å¯¹Monocle3çš„ç»“æœè¿›è¡Œç»†èƒæ³¨é‡Šï¼Œä½†æ®è¯´æ•ˆæœä¸€èˆ¬ã€‚


```{r}
#æ³¨æ„å®‰è£…é¡ºåºï¼ŒåŒ…ä¸åŒ…ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»
# BiocManager::install('dynwrap')
# BiocManager::install('dynfeature')
# BiocManager::install('dynplot')
#ä¸€èˆ¬æ— æ³•å®‰è£…ç›´æ¥ä¸‹è½½æºç æœ¬åœ°å®‰è£…
# devtools::install_local('dynverse/dynguidelines-master.zip')
# devtools::install_local('dynverse/dynmethods-master.zip')
# devtools::install_local('dynverse/dyno-master.zip')
library(dyno)
library(tidyverse)
library(SummarizedExperiment)
```

```{r}
load('dynverse/mm_seob.rdata')
#mm_seobä¸­çš„æ•°æ®å¹¶æ²¡æœ‰è¿›è¡Œæ ‡å‡†åŒ–
mm_seob <- NormalizeData(mm_seob)
glimpse(mm_seob@assays, max.level = 4)

counts_data <- as.data.frame(mm_seob@assays$RNA@counts)
data_data <- as.data.frame(mm_seob@assays$RNA@data)
counts_data[1:5,1:5]
data_data[1:5,1:5]
```






